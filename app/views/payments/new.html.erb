<h1 class="h3 mb-3">Novo Pagamento</h1>

<%= form_with model: @payment, local: true, multipart: true, class: "needs-validation", novalidate: true do |form| %>
  <% if @payment.errors.any? %>
    <div class="alert alert-danger">
      <h5><%= pluralize(@payment.errors.count, "erro") %> impediram este pagamento de ser salvo:</h5>
      <ul class="mb-0">
        <% @payment.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="card">
    <div class="card-body">
      <% if @curators.count > 1 %>
        <div class="mb-3">
          <%= form.label :curator_id, "Curador Respons√°vel", class: "form-label" %>
          <%= form.collection_select :curator_id, @curators, :id, :email, 
              { prompt: "Selecione..." }, 
              { class: "form-select", id: "curator_select" } %>
          <small class="form-text text-muted">Para quem √© este pagamento?</small>
        </div>
      <% else %>
        <%= form.hidden_field :curator_id, value: current_user.id %>
      <% end %>

      <div class="row g-3 mb-3">
        <div class="col-12 col-md-6">
          <%= form.label :primary_classification_id, "Classifica√ß√£o Prim√°ria", class: "form-label" %>
          <%= form.collection_select :primary_classification_id, @primary_classifications, :id, :name, 
              { prompt: "Selecione..." }, 
              { class: "form-select", id: "primary_classification_select", required: true } %>
        </div>
        <div class="col-12 col-md-6">
          <%= form.label :secondary_classification_id, "Classifica√ß√£o Secund√°ria", class: "form-label" %>
          <%= form.collection_select :secondary_classification_id, @secondary_classifications, :id, :name, 
              { prompt: "Selecione..." }, 
              { class: "form-select", id: "secondary_classification_select", required: true } %>
        </div>
      </div>

      <div class="mb-3">
        <%= form.label :description, "Descri√ß√£o", class: "form-label" %>
        <%= form.text_area :description, class: "form-control", rows: 3 %>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-12 col-md-6">
          <%= form.label :partner_name, "Nome do Parceiro/Fornecedor", class: "form-label" %>
          <%= form.text_field :partner_name, class: "form-control", id: "partner_name_input", 
              placeholder: "Digite o nome ou CPF/CNPJ para buscar", 
              autocomplete: "off" %>
          <div id="partner_suggestions" class="list-group position-absolute" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto; width: calc(100% - 24px);"></div>
        </div>
        <div class="col-12 col-md-6">
          <%= form.label :cpf_cnpj, "CPF/CNPJ", class: "form-label" %>
          <%= form.text_field :cpf_cnpj, class: "form-control", id: "cpf_cnpj_input" %>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-12 col-md-4">
          <%= form.label :value, "Valor", class: "form-label" %>
          <div class="input-group">
            <span class="input-group-text">R$</span>
            <%= form.number_field :value, class: "form-control", step: 0.01, min: 0, required: true %>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <%= form.label :date, "Data", class: "form-label" %>
          <%= form.date_field :date, class: "form-control", required: true %>
        </div>
        <div class="col-12 col-md-4">
          <%= form.label :payment_method, "Como foi pago", class: "form-label" %>
          <%= form.text_field :payment_method, class: "form-control", placeholder: "Ex: PIX, Cart√£o" %>
        </div>
      </div>

      <div class="mb-3">
        <%= form.label :document_photo, "Foto do Documento", class: "form-label" %>
        <div class="d-grid gap-2 d-md-block mb-2">
          <input type="file" id="camera_input" accept="image/*" capture="environment" style="display: none;">
          <button type="button" class="btn btn-outline-primary w-100 w-md-auto" onclick="document.getElementById('camera_input').click();">
            üì∑ Capturar da C√¢mera
          </button>
          <button type="button" class="btn btn-outline-secondary w-100 w-md-auto" onclick="document.getElementById('payment_document_photo').click();">
            üìÅ Enviar Arquivo
          </button>
        </div>
        <%= form.file_field :document_photo, class: "form-control", id: "payment_document_photo", accept: "image/*", required: true %>
        <div id="image_preview" class="mt-3" style="display: none;">
          <img id="preview_img" src="" alt="Preview" class="img-fluid rounded border" style="max-width: 100%;">
        </div>
      </div>

      <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
        <%= link_to "Cancelar", payments_path, class: "btn btn-secondary order-md-2" %>
        <%= form.submit "Salvar Pagamento", class: "btn btn-primary order-md-1" %>
      </div>
    </div>
  </div>
<% end %>

<script>
  let partnerSuggestionsTimeout = null;

  // Partner autocomplete
  document.getElementById('partner_name_input').addEventListener('input', function(e) {
    clearTimeout(partnerSuggestionsTimeout);
    const query = e.target.value;
    const suggestionsDiv = document.getElementById('partner_suggestions');
    
    if (query.length < 2) {
      suggestionsDiv.style.display = 'none';
      return;
    }
    
    partnerSuggestionsTimeout = setTimeout(() => {
      fetch(`/payments/cpf_cnpj_suggestions?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          // Clear previous suggestions safely
          while (suggestionsDiv.firstChild) {
            suggestionsDiv.removeChild(suggestionsDiv.firstChild);
          }
          
          if (data.length > 0) {
            data.forEach(partner => {
              // Validate partner data
              if (!partner.name || !partner.cpf_cnpj || !partner.label) {
                return;
              }
              
              const item = document.createElement('a');
              item.href = '#';
              item.className = 'list-group-item list-group-item-action';
              // Use textContent to prevent XSS
              item.textContent = partner.label;
              item.onclick = function(e) {
                e.preventDefault();
                // Sanitize by setting value properties directly
                const nameInput = document.getElementById('partner_name_input');
                const cpfInput = document.getElementById('cpf_cnpj_input');
                if (nameInput && cpfInput) {
                  nameInput.value = String(partner.name);
                  cpfInput.value = String(partner.cpf_cnpj);
                }
                suggestionsDiv.style.display = 'none';
              };
              suggestionsDiv.appendChild(item);
            });
            suggestionsDiv.style.display = 'block';
          } else {
            suggestionsDiv.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error fetching partner suggestions:', error);
          suggestionsDiv.style.display = 'none';
        });
    }, 300);
  });
  
  // Hide suggestions when clicking outside
  document.addEventListener('click', function(e) {
    const suggestionsDiv = document.getElementById('partner_suggestions');
    const nameInput = document.getElementById('partner_name_input');
    if (e.target !== nameInput && !suggestionsDiv.contains(e.target)) {
      suggestionsDiv.style.display = 'none';
    }
  });

  // Atualizar classifica√ß√µes secund√°rias quando prim√°ria mudar
  document.getElementById('primary_classification_select').addEventListener('change', function() {
    const primaryId = this.value;
    const secondarySelect = document.getElementById('secondary_classification_select');
    
    if (primaryId) {
      fetch(`/payments/secondary_classifications?primary_classification_id=${primaryId}`)
        .then(response => response.json())
        .then(data => {
          secondarySelect.innerHTML = '<option value="">Selecione...</option>';
          data.forEach(function(item) {
            const option = document.createElement('option');
            option.value = item.id;
            option.textContent = item.name;
            secondarySelect.appendChild(option);
          });
        });
    } else {
      secondarySelect.innerHTML = '<option value="">Selecione...</option>';
    }
  });

  // Preview da imagem
  document.getElementById('payment_document_photo').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('preview_img').src = e.target.result;
        document.getElementById('image_preview').style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  });

  // Captura da c√¢mera
  document.getElementById('camera_input').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      document.getElementById('payment_document_photo').files = dataTransfer.files;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('preview_img').src = e.target.result;
        document.getElementById('image_preview').style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  });
</script>

